<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Enhanced MCP Test Extension - Options</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px;
    }
    
    .section {
      background: white;
      margin: 20px 0;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .section h3 {
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    
    .config-item {
      margin: 15px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
      border-left: 4px solid #667eea;
    }
    
    .config-item label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
    }
    
    .config-item input, .config-item select, .config-item textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .config-item textarea {
      height: 100px;
      resize: vertical;
    }
    
    .button-group {
      text-align: center;
      margin: 20px 0;
    }
    
    .btn {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5a6fd8;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #545b62;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn-danger:hover {
      background: #c82333;
    }
    
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      text-align: center;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .log-viewer {
      background: #000;
      color: #00ff00;
      font-family: 'Courier New', monospace;
      padding: 15px;
      border-radius: 5px;
      height: 300px;
      overflow-y: auto;
      font-size: 12px;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ“¡ Enhanced MCP Test Extension</h1>
    <p>Week 3 åŠŸèƒ½æµ‹è¯• - é…ç½®å’Œç›‘æ§é¢æ¿</p>
  </div>

  <div class="section">
    <h3>ğŸ”§ ç›‘æ§é…ç½®</h3>
    
    <div class="config-item">
      <label for="monitoringInterval">æ¶ˆæ¯ç›‘æ§é—´éš” (ç§’)</label>
      <input type="number" id="monitoringInterval" value="10" min="1" max="300">
    </div>
    
    <div class="config-item">
      <label for="logLevel">æ—¥å¿—çº§åˆ«</label>
      <select id="logLevel">
        <option value="debug">Debug (å…¨éƒ¨)</option>
        <option value="info" selected>Info (ä¿¡æ¯)</option>
        <option value="warn">Warn (è­¦å‘Š)</option>
        <option value="error">Error (é”™è¯¯)</option>
      </select>
    </div>
    
    <div class="config-item">
      <label for="messageTypes">ç›‘æ§çš„æ¶ˆæ¯ç±»å‹</label>
      <div style="margin: 10px 0;">
        <input type="checkbox" id="runtimeMessages" checked> 
        <label for="runtimeMessages" style="display: inline; margin-left: 5px;">Runtime Messages</label>
      </div>
      <div style="margin: 10px 0;">
        <input type="checkbox" id="tabMessages" checked> 
        <label for="tabMessages" style="display: inline; margin-left: 5px;">Tab Messages</label>
      </div>
      <div style="margin: 10px 0;">
        <input type="checkbox" id="externalMessages"> 
        <label for="externalMessages" style="display: inline; margin-left: 5px;">External Messages</label>
      </div>
    </div>
    
    <div class="config-item">
      <label for="customScript">è‡ªå®šä¹‰æµ‹è¯•è„šæœ¬</label>
      <textarea id="customScript" placeholder="è¾“å…¥è‡ªå®šä¹‰JavaScriptä»£ç ç”¨äºæµ‹è¯•...">
// Week 3æµ‹è¯•è„šæœ¬ç¤ºä¾‹
console.log('[Custom Test] æ‰§è¡Œè‡ªå®šä¹‰æµ‹è¯•');

// æµ‹è¯•DOMæ“ä½œ
const testElement = document.createElement('div');
testElement.textContent = 'Custom Test Element';
testElement.style.cssText = 'background: yellow; padding: 5px; position: fixed; top: 100px; right: 10px; z-index: 999999;';
document.body.appendChild(testElement);

setTimeout(() => {
  if (testElement.parentNode) {
    testElement.parentNode.removeChild(testElement);
  }
}, 3000);
      </textarea>
    </div>
  </div>

  <div class="section">
    <h3>ğŸš€ æµ‹è¯•æ§åˆ¶</h3>
    
    <div class="button-group">
      <button class="btn btn-primary" id="startFullTest">å¼€å§‹å®Œæ•´æµ‹è¯•</button>
      <button class="btn btn-secondary" id="runCustomScript">è¿è¡Œè‡ªå®šä¹‰è„šæœ¬</button>
      <button class="btn btn-primary" id="saveConfig">ä¿å­˜é…ç½®</button>
      <button class="btn btn-secondary" id="loadConfig">åŠ è½½é…ç½®</button>
      <button class="btn btn-danger" id="resetConfig">é‡ç½®é…ç½®</button>
    </div>
    
    <div id="testStatus" class="status" style="display: none;"></div>
  </div>

  <div class="section">
    <h3>ğŸ“Š å®æ—¶ç›‘æ§</h3>
    
    <div class="button-group">
      <button class="btn btn-primary" id="startMonitoring">å¼€å§‹ç›‘æ§</button>
      <button class="btn btn-secondary" id="stopMonitoring">åœæ­¢ç›‘æ§</button>
      <button class="btn btn-secondary" id="clearLogs">æ¸…é™¤æ—¥å¿—</button>
      <button class="btn btn-secondary" id="exportLogs">å¯¼å‡ºæ—¥å¿—</button>
    </div>
    
    <div class="log-viewer" id="logViewer">
      [Options] ğŸ“¡ Enhanced MCP Test Extension - Optionsé¡µé¢å·²åŠ è½½
      [Options] â³ ç­‰å¾…ç”¨æˆ·å¼€å§‹ç›‘æ§...
    </div>
  </div>

  <div class="section">
    <h3>ğŸ“‹ æ‰©å±•ä¿¡æ¯</h3>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
      <div>
        <strong>æ‰©å±•ID:</strong> <span id="extensionId">åŠ è½½ä¸­...</span><br>
        <strong>ç‰ˆæœ¬:</strong> <span id="extensionVersion">åŠ è½½ä¸­...</span><br>
        <strong>Manifestç‰ˆæœ¬:</strong> <span id="manifestVersion">åŠ è½½ä¸­...</span>
      </div>
      <div>
        <strong>æ´»åŠ¨æ ‡ç­¾æ•°:</strong> <span id="tabCount">æ£€æŸ¥ä¸­...</span><br>
        <strong>å­˜å‚¨ä½¿ç”¨:</strong> <span id="storageUsage">è®¡ç®—ä¸­...</span><br>
        <strong>è¿è¡Œæ—¶é—´:</strong> <span id="uptime">00:00:00</span>
      </div>
    </div>
  </div>

  <script>
    // Week 3æµ‹è¯•ï¼šOptionsé¡µé¢é€»è¾‘
    let monitoringActive = false;
    let startTime = Date.now();
    
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('[Options] ğŸš€ Optionsé¡µé¢åˆå§‹åŒ–');
      
      await loadExtensionInfo();
      await loadConfig();
      bindEventHandlers();
      startPeriodicUpdates();
      
      console.log('[Options] âœ… Optionsé¡µé¢åˆå§‹åŒ–å®Œæˆ');
    });
    
    async function loadExtensionInfo() {
      try {
        const manifest = chrome.runtime.getManifest();
        document.getElementById('extensionId').textContent = chrome.runtime.id;
        document.getElementById('extensionVersion').textContent = manifest.version;
        document.getElementById('manifestVersion').textContent = manifest.manifest_version;
        
        // è·å–æ ‡ç­¾æ•°
        const tabs = await chrome.tabs.query({});
        document.getElementById('tabCount').textContent = tabs.length;
        
        // è®¡ç®—å­˜å‚¨ä½¿ç”¨
        const storage = await chrome.storage.local.get(null);
        const storageSize = JSON.stringify(storage).length;
        document.getElementById('storageUsage').textContent = `${storageSize} bytes`;
        
      } catch (error) {
        console.error('[Options] âŒ åŠ è½½æ‰©å±•ä¿¡æ¯å¤±è´¥:', error);
      }
    }
    
    async function loadConfig() {
      try {
        const config = await chrome.storage.local.get(['mcpTestConfig']);
        if (config.mcpTestConfig) {
          const cfg = config.mcpTestConfig;
          document.getElementById('monitoringInterval').value = cfg.interval || 10;
          document.getElementById('logLevel').value = cfg.logLevel || 'info';
          document.getElementById('runtimeMessages').checked = cfg.runtimeMessages !== false;
          document.getElementById('tabMessages').checked = cfg.tabMessages !== false;
          document.getElementById('externalMessages').checked = cfg.externalMessages || false;
          if (cfg.customScript) {
            document.getElementById('customScript').value = cfg.customScript;
          }
          
          appendLog('[Options] âœ… é…ç½®åŠ è½½æˆåŠŸ');
        }
      } catch (error) {
        appendLog('[Options] âŒ åŠ è½½é…ç½®å¤±è´¥: ' + error.message);
      }
    }
    
    function bindEventHandlers() {
      // ä¿å­˜é…ç½®
      document.getElementById('saveConfig').addEventListener('click', async () => {
        try {
          const config = {
            interval: parseInt(document.getElementById('monitoringInterval').value),
            logLevel: document.getElementById('logLevel').value,
            runtimeMessages: document.getElementById('runtimeMessages').checked,
            tabMessages: document.getElementById('tabMessages').checked,
            externalMessages: document.getElementById('externalMessages').checked,
            customScript: document.getElementById('customScript').value
          };
          
          await chrome.storage.local.set({ mcpTestConfig: config });
          showStatus('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
          appendLog('[Options] ğŸ’¾ é…ç½®å·²ä¿å­˜');
        } catch (error) {
          showStatus('é…ç½®ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        }
      });
      
      // å¼€å§‹å®Œæ•´æµ‹è¯•
      document.getElementById('startFullTest').addEventListener('click', async () => {
        try {
          appendLog('[Options] ğŸš€ å¼€å§‹å®Œæ•´åŠŸèƒ½æµ‹è¯•');
          
          // å‘é€æ¶ˆæ¯åˆ°æ‰€æœ‰æ ‡ç­¾é¡µ
          const tabs = await chrome.tabs.query({});
          let testCount = 0;
          
          for (const tab of tabs) {
            if (tab.url && !tab.url.startsWith('chrome://')) {
              try {
                await chrome.tabs.sendMessage(tab.id, {
                  type: 'full_test_trigger',
                  timestamp: Date.now(),
                  testId: `full_test_${Date.now()}`
                });
                testCount++;
              } catch (error) {
                appendLog(`[Options] âš ï¸ Tab ${tab.id} æµ‹è¯•å¤±è´¥: ${error.message}`);
              }
            }
          }
          
          appendLog(`[Options] âœ… å®Œæ•´æµ‹è¯•å·²å‘é€åˆ° ${testCount} ä¸ªæ ‡ç­¾é¡µ`);
          showStatus(`æµ‹è¯•å·²å‘é€åˆ° ${testCount} ä¸ªæ ‡ç­¾é¡µ`, 'success');
        } catch (error) {
          appendLog('[Options] âŒ å®Œæ•´æµ‹è¯•å¤±è´¥: ' + error.message);
          showStatus('æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
        }
      });
      
      // è¿è¡Œè‡ªå®šä¹‰è„šæœ¬
      document.getElementById('runCustomScript').addEventListener('click', async () => {
        try {
          const script = document.getElementById('customScript').value;
          if (!script.trim()) {
            showStatus('è¯·è¾“å…¥è‡ªå®šä¹‰è„šæœ¬', 'error');
            return;
          }
          
          appendLog('[Options] ğŸ”§ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬');
          
          const tabs = await chrome.tabs.query({ active: true, currentWindow: true });
          if (tabs[0] && tabs[0].id) {
            await chrome.tabs.sendMessage(tabs[0].id, {
              type: 'run_custom_script',
              script: script,
              timestamp: Date.now()
            });
            
            appendLog('[Options] âœ… è‡ªå®šä¹‰è„šæœ¬å·²å‘é€');
            showStatus('è‡ªå®šä¹‰è„šæœ¬å·²æ‰§è¡Œ', 'success');
          } else {
            showStatus('æ²¡æœ‰æ´»åŠ¨æ ‡ç­¾é¡µ', 'error');
          }
        } catch (error) {
          appendLog('[Options] âŒ è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå¤±è´¥: ' + error.message);
          showStatus('è„šæœ¬æ‰§è¡Œå¤±è´¥: ' + error.message, 'error');
        }
      });
      
      // å¼€å§‹ç›‘æ§
      document.getElementById('startMonitoring').addEventListener('click', () => {
        monitoringActive = true;
        appendLog('[Options] ğŸ“¡ å¼€å§‹å®æ—¶ç›‘æ§');
        showStatus('ç›‘æ§å·²å¼€å§‹', 'success');
      });
      
      // åœæ­¢ç›‘æ§
      document.getElementById('stopMonitoring').addEventListener('click', () => {
        monitoringActive = false;
        appendLog('[Options] ğŸ›‘ ç›‘æ§å·²åœæ­¢');
        showStatus('ç›‘æ§å·²åœæ­¢', 'success');
      });
      
      // æ¸…é™¤æ—¥å¿—
      document.getElementById('clearLogs').addEventListener('click', () => {
        document.getElementById('logViewer').innerHTML = '';
        appendLog('[Options] ğŸ§¹ æ—¥å¿—å·²æ¸…é™¤');
      });
      
      // å¯¼å‡ºæ—¥å¿—
      document.getElementById('exportLogs').addEventListener('click', () => {
        const logs = document.getElementById('logViewer').textContent;
        const blob = new Blob([logs], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `mcp-test-logs-${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.txt`;
        a.click();
        
        URL.revokeObjectURL(url);
        appendLog('[Options] ğŸ“„ æ—¥å¿—å·²å¯¼å‡º');
      });
    }
    
    function showStatus(message, type) {
      const statusEl = document.getElementById('testStatus');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
      statusEl.style.display = 'block';
      
      setTimeout(() => {
        statusEl.style.display = 'none';
      }, 3000);
    }
    
    function appendLog(message) {
      const logViewer = document.getElementById('logViewer');
      const timestamp = new Date().toLocaleTimeString();
      logViewer.innerHTML += `\n[${timestamp}] ${message}`;
      logViewer.scrollTop = logViewer.scrollHeight;
    }
    
    function startPeriodicUpdates() {
      setInterval(async () => {
        // æ›´æ–°è¿è¡Œæ—¶é—´
        const elapsed = Date.now() - startTime;
        const hours = Math.floor(elapsed / 3600000);
        const minutes = Math.floor((elapsed % 3600000) / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        document.getElementById('uptime').textContent = 
          `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
        
        // å¦‚æœç›‘æ§æ´»è·ƒï¼Œæ·»åŠ å®šæœŸæ—¥å¿—
        if (monitoringActive && Math.random() < 0.3) {
          appendLog(`[Monitor] ğŸ“Š ç›‘æ§æ´»è·ƒ - å†…å­˜: ${performance.memory ? Math.round(performance.memory.usedJSHeapSize/1024/1024) + 'MB' : 'N/A'}`);
        }
      }, 1000);
      
      // å®šæœŸæ›´æ–°æ ‡ç­¾æ•°å’Œå­˜å‚¨ä½¿ç”¨
      setInterval(async () => {
        try {
          const tabs = await chrome.tabs.query({});
          document.getElementById('tabCount').textContent = tabs.length;
          
          const storage = await chrome.storage.local.get(null);
          const storageSize = JSON.stringify(storage).length;
          document.getElementById('storageUsage').textContent = `${storageSize} bytes`;
        } catch (error) {
          console.error('[Options] âŒ å®šæœŸæ›´æ–°å¤±è´¥:', error);
        }
      }, 5000);
    }
    
    // Week 3æµ‹è¯•ï¼šç›‘å¬æ¥è‡ªbackgroundçš„æ¶ˆæ¯
    chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
      if (monitoringActive) {
        appendLog(`[Monitor] ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(message).substring(0, 100)}...`);
      }
    });
  </script>
</body>
</html>
