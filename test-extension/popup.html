<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MCP Debug Test Extension</title>
  <style>
    body {
      width: 300px;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin: 0;
    }
    
    .header {
      text-align: center;
      margin-bottom: 16px;
    }
    
    .status {
      background: rgba(255, 255, 255, 0.1);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .button {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border: none;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .button:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .info {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 12px;
    }
    
    .log-output {
      background: rgba(0, 0, 0, 0.3);
      padding: 8px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 11px;
      max-height: 100px;
      overflow-y: auto;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h3>ğŸ” MCP Debug Test</h3>
    <div class="status" id="status">
      ğŸ“Š çŠ¶æ€: <span id="extensionStatus">æ£€æŸ¥ä¸­...</span>
    </div>
  </div>
  
  <button class="button" id="testLogs">ğŸ“ ç”Ÿæˆæµ‹è¯•æ—¥å¿—</button>
  <button class="button" id="testStorage">ğŸ—„ï¸ æµ‹è¯•å­˜å‚¨API</button>
  <button class="button" id="testPerformance">âš¡ æ€§èƒ½æµ‹è¯•</button>
  <button class="button" id="simulateError">ğŸ”¥ æ¨¡æ‹Ÿé”™è¯¯</button>
  <button class="button" id="checkInjection">ğŸ¯ æ£€æŸ¥æ³¨å…¥çŠ¶æ€</button>
  
  <div class="log-output" id="logOutput" style="display: none;">
    <div>ğŸ“‹ æ“ä½œæ—¥å¿—:</div>
    <div id="logs"></div>
  </div>
  
  <div class="info">
    <div>ğŸ†” æ‰©å±•ID: <span id="extensionId">-</span></div>
    <div>ğŸ“¦ ç‰ˆæœ¬: <span id="extensionVersion">-</span></div>
    <div>â±ï¸ è¿è¡Œæ—¶é—´: <span id="uptime">-</span></div>
  </div>

  <script>
    // Popup script for MCP Debug Test Extension
    console.log('[Popup] ğŸ›ï¸ Popupé¡µé¢åŠ è½½');
    
    const elements = {
      status: document.getElementById('extensionStatus'),
      extensionId: document.getElementById('extensionId'),
      extensionVersion: document.getElementById('extensionVersion'),
      uptime: document.getElementById('uptime'),
      logOutput: document.getElementById('logOutput'),
      logs: document.getElementById('logs')
    };
    
    // åˆå§‹åŒ–æ‰©å±•ä¿¡æ¯
    function initializeExtensionInfo() {
      const manifest = chrome.runtime.getManifest();
      elements.extensionId.textContent = chrome.runtime.id;
      elements.extensionVersion.textContent = manifest.version;
      elements.status.textContent = 'âœ… æ´»è·ƒ';
      
      console.log('[Popup] ğŸ“‹ æ‰©å±•ä¿¡æ¯å·²åŠ è½½:', {
        id: chrome.runtime.id,
        version: manifest.version
      });
    }
    
    // æ·»åŠ æ—¥å¿—
    function addLog(message) {
      const logEntry = document.createElement('div');
      logEntry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
      elements.logs.appendChild(logEntry);
      elements.logOutput.style.display = 'block';
      elements.logs.scrollTop = elements.logs.scrollHeight;
      
      console.log('[Popup] ğŸ“', message);
    }
    
    // å‘é€æ¶ˆæ¯åˆ°background
    function sendBackgroundMessage(type, data = {}) {
      return new Promise((resolve) => {
        chrome.runtime.sendMessage({ type, ...data }, (response) => {
          resolve(response);
        });
      });
    }
    
    // æŒ‰é’®äº‹ä»¶å¤„ç†
    document.getElementById('testLogs').addEventListener('click', async () => {
      addLog('ç”Ÿæˆæµ‹è¯•æ—¥å¿—...');
      
      // ç”Ÿæˆä¸åŒçº§åˆ«çš„æ—¥å¿—
      console.log('[Popup] ğŸ“ ç”¨æˆ·è§¦å‘æ—¥å¿—æµ‹è¯•');
      console.info('[Popup] â„¹ï¸ ä¿¡æ¯çº§åˆ«æµ‹è¯•æ—¥å¿—');
      console.warn('[Popup] âš ï¸ è­¦å‘Šçº§åˆ«æµ‹è¯•æ—¥å¿—');
      console.error('[Popup] âŒ é”™è¯¯çº§åˆ«æµ‹è¯•æ—¥å¿—');
      
      addLog('âœ… æµ‹è¯•æ—¥å¿—å·²ç”Ÿæˆ');
    });
    
    document.getElementById('testStorage').addEventListener('click', async () => {
      addLog('æµ‹è¯•å­˜å‚¨API...');
      
      const response = await sendBackgroundMessage('test-storage');
      console.log('[Popup] ğŸ—„ï¸ å­˜å‚¨æµ‹è¯•å“åº”:', response);
      
      addLog('âœ… å­˜å‚¨æµ‹è¯•å®Œæˆ');
    });
    
    document.getElementById('testPerformance').addEventListener('click', async () => {
      addLog('æ‰§è¡Œæ€§èƒ½æµ‹è¯•...');
      
      const startTime = performance.now();
      const response = await sendBackgroundMessage('performance-test');
      const endTime = performance.now();
      
      console.log('[Popup] âš¡ æ€§èƒ½æµ‹è¯•ç»“æœ:', response);
      addLog(`âš¡ æ€§èƒ½æµ‹è¯•: ${(endTime - startTime).toFixed(2)}ms`);
    });
    
    document.getElementById('simulateError').addEventListener('click', async () => {
      addLog('æ¨¡æ‹Ÿé”™è¯¯...');
      
      // Popupç«¯çš„é”™è¯¯
      console.error('[Popup] ğŸ”¥ Popupæ¨¡æ‹Ÿé”™è¯¯:', new Error('Popup test error'));
      
      // Backgroundç«¯çš„é”™è¯¯
      await sendBackgroundMessage('simulate-error');
      
      addLog('ğŸ”¥ é”™è¯¯å·²æ¨¡æ‹Ÿ');
    });
    
    document.getElementById('checkInjection').addEventListener('click', async () => {
      addLog('æ£€æŸ¥æ³¨å…¥çŠ¶æ€...');
      
      try {
        // è·å–å½“å‰æ´»è·ƒæ ‡ç­¾é¡µ
        const tabs = await chrome.tabs.query({ active: true, currentWindow: true });
        if (tabs[0]) {
          const response = await chrome.tabs.sendMessage(tabs[0].id, {
            type: 'get-injection-status'
          });
          
          console.log('[Popup] ğŸ¯ æ³¨å…¥çŠ¶æ€:', response);
          addLog(`ğŸ¯ æ³¨å…¥çŠ¶æ€: ${response.status}`);
          
          if (response.data) {
            addLog(`ğŸ“Š å…ƒç´ æ•°: ${response.data.domElements}`);
            addLog(`âš ï¸ å†²çª: ${response.data.hasConflicts ? 'æ£€æµ‹åˆ°' : 'æ— '}`);
          }
        }
      } catch (error) {
        console.warn('[Popup] âš ï¸ æ— æ³•è·å–æ³¨å…¥çŠ¶æ€:', error);
        addLog('âš ï¸ æ— æ³•æ£€æŸ¥æ³¨å…¥çŠ¶æ€ (é¡µé¢ä¸æ”¯æŒ)');
      }
    });
    
    // æ›´æ–°è¿è¡Œæ—¶é—´
    function updateUptime() {
      sendBackgroundMessage('get-extension-info').then(response => {
        if (response && response.data) {
          const uptimeSeconds = Math.floor(response.data.uptime / 1000);
          elements.uptime.textContent = `${uptimeSeconds}s`;
        }
      });
    }
    
    // åˆå§‹åŒ–
    initializeExtensionInfo();
    updateUptime();
    
    // å®šæœŸæ›´æ–°è¿è¡Œæ—¶é—´
    setInterval(updateUptime, 2000);
    
    console.log('[Popup] âœ¨ Popupåˆå§‹åŒ–å®Œæˆ');
  </script>
</body>
</html>
