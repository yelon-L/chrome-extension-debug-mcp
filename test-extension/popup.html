<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MCP Debug Test Extension</title>
  <style>
    body {
      width: 300px;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin: 0;
    }
    
    .header {
      text-align: center;
      margin-bottom: 16px;
    }
    
    .status {
      background: rgba(255, 255, 255, 0.1);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .button {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border: none;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .button:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .info {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 12px;
    }
    
    .log-output {
      background: rgba(0, 0, 0, 0.3);
      padding: 8px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 11px;
      max-height: 100px;
      overflow-y: auto;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h3>🔍 MCP Debug Test</h3>
    <div class="status" id="status">
      📊 状态: <span id="extensionStatus">检查中...</span>
    </div>
  </div>
  
  <button class="button" id="testLogs">📝 生成测试日志</button>
  <button class="button" id="testStorage">🗄️ 测试存储API</button>
  <button class="button" id="testPerformance">⚡ 性能测试</button>
  <button class="button" id="simulateError">🔥 模拟错误</button>
  <button class="button" id="checkInjection">🎯 检查注入状态</button>
  
  <div class="log-output" id="logOutput" style="display: none;">
    <div>📋 操作日志:</div>
    <div id="logs"></div>
  </div>
  
  <div class="info">
    <div>🆔 扩展ID: <span id="extensionId">-</span></div>
    <div>📦 版本: <span id="extensionVersion">-</span></div>
    <div>⏱️ 运行时间: <span id="uptime">-</span></div>
  </div>

  <script>
    // Popup script for MCP Debug Test Extension
    console.log('[Popup] 🎛️ Popup页面加载');
    
    const elements = {
      status: document.getElementById('extensionStatus'),
      extensionId: document.getElementById('extensionId'),
      extensionVersion: document.getElementById('extensionVersion'),
      uptime: document.getElementById('uptime'),
      logOutput: document.getElementById('logOutput'),
      logs: document.getElementById('logs')
    };
    
    // 初始化扩展信息
    function initializeExtensionInfo() {
      const manifest = chrome.runtime.getManifest();
      elements.extensionId.textContent = chrome.runtime.id;
      elements.extensionVersion.textContent = manifest.version;
      elements.status.textContent = '✅ 活跃';
      
      console.log('[Popup] 📋 扩展信息已加载:', {
        id: chrome.runtime.id,
        version: manifest.version
      });
    }
    
    // 添加日志
    function addLog(message) {
      const logEntry = document.createElement('div');
      logEntry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
      elements.logs.appendChild(logEntry);
      elements.logOutput.style.display = 'block';
      elements.logs.scrollTop = elements.logs.scrollHeight;
      
      console.log('[Popup] 📝', message);
    }
    
    // 发送消息到background
    function sendBackgroundMessage(type, data = {}) {
      return new Promise((resolve) => {
        chrome.runtime.sendMessage({ type, ...data }, (response) => {
          resolve(response);
        });
      });
    }
    
    // 按钮事件处理
    document.getElementById('testLogs').addEventListener('click', async () => {
      addLog('生成测试日志...');
      
      // 生成不同级别的日志
      console.log('[Popup] 📝 用户触发日志测试');
      console.info('[Popup] ℹ️ 信息级别测试日志');
      console.warn('[Popup] ⚠️ 警告级别测试日志');
      console.error('[Popup] ❌ 错误级别测试日志');
      
      addLog('✅ 测试日志已生成');
    });
    
    document.getElementById('testStorage').addEventListener('click', async () => {
      addLog('测试存储API...');
      
      const response = await sendBackgroundMessage('test-storage');
      console.log('[Popup] 🗄️ 存储测试响应:', response);
      
      addLog('✅ 存储测试完成');
    });
    
    document.getElementById('testPerformance').addEventListener('click', async () => {
      addLog('执行性能测试...');
      
      const startTime = performance.now();
      const response = await sendBackgroundMessage('performance-test');
      const endTime = performance.now();
      
      console.log('[Popup] ⚡ 性能测试结果:', response);
      addLog(`⚡ 性能测试: ${(endTime - startTime).toFixed(2)}ms`);
    });
    
    document.getElementById('simulateError').addEventListener('click', async () => {
      addLog('模拟错误...');
      
      // Popup端的错误
      console.error('[Popup] 🔥 Popup模拟错误:', new Error('Popup test error'));
      
      // Background端的错误
      await sendBackgroundMessage('simulate-error');
      
      addLog('🔥 错误已模拟');
    });
    
    document.getElementById('checkInjection').addEventListener('click', async () => {
      addLog('检查注入状态...');
      
      try {
        // 获取当前活跃标签页
        const tabs = await chrome.tabs.query({ active: true, currentWindow: true });
        if (tabs[0]) {
          const response = await chrome.tabs.sendMessage(tabs[0].id, {
            type: 'get-injection-status'
          });
          
          console.log('[Popup] 🎯 注入状态:', response);
          addLog(`🎯 注入状态: ${response.status}`);
          
          if (response.data) {
            addLog(`📊 元素数: ${response.data.domElements}`);
            addLog(`⚠️ 冲突: ${response.data.hasConflicts ? '检测到' : '无'}`);
          }
        }
      } catch (error) {
        console.warn('[Popup] ⚠️ 无法获取注入状态:', error);
        addLog('⚠️ 无法检查注入状态 (页面不支持)');
      }
    });
    
    // 更新运行时间
    function updateUptime() {
      sendBackgroundMessage('get-extension-info').then(response => {
        if (response && response.data) {
          const uptimeSeconds = Math.floor(response.data.uptime / 1000);
          elements.uptime.textContent = `${uptimeSeconds}s`;
        }
      });
    }
    
    // 初始化
    initializeExtensionInfo();
    updateUptime();
    
    // 定期更新运行时间
    setInterval(updateUptime, 2000);
    
    console.log('[Popup] ✨ Popup初始化完成');
  </script>
</body>
</html>
