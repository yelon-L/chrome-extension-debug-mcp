<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MCP Debug Test Extension - 选项</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 24px;
    }
    
    .section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .section h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #eee;
      padding-bottom: 8px;
    }
    
    .option-group {
      margin-bottom: 16px;
    }
    
    .option-group label {
      display: block;
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .option-group input,
    .option-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }
    
    .button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    
    .button:hover {
      background: #45a049;
    }
    
    .button.secondary {
      background: #6c757d;
    }
    
    .button.secondary:hover {
      background: #5a6268;
    }
    
    .status {
      padding: 12px;
      border-radius: 6px;
      margin: 12px 0;
      display: none;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .debug-info {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>🔍 MCP Debug Test Extension</h1>
    <p>扩展调试功能配置与测试</p>
  </div>
  
  <div class="section">
    <h3>📊 扩展信息</h3>
    <div class="option-group">
      <label>扩展ID:</label>
      <input type="text" id="extensionId" readonly>
    </div>
    <div class="option-group">
      <label>版本:</label>
      <input type="text" id="extensionVersion" readonly>
    </div>
    <div class="option-group">
      <label>Manifest版本:</label>
      <input type="text" id="manifestVersion" readonly>
    </div>
  </div>
  
  <div class="section">
    <h3>🔧 调试配置</h3>
    <div class="checkbox-group">
      <input type="checkbox" id="enableVerboseLogging">
      <label for="enableVerboseLogging">启用详细日志记录</label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="enablePerformanceMonitoring">
      <label for="enablePerformanceMonitoring">启用性能监控</label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="enableConflictDetection">
      <label for="enableConflictDetection">启用冲突检测</label>
    </div>
    <div class="option-group">
      <label for="logLevel">日志级别:</label>
      <select id="logLevel">
        <option value="debug">Debug</option>
        <option value="info" selected>Info</option>
        <option value="warn">Warning</option>
        <option value="error">Error</option>
      </select>
    </div>
  </div>
  
  <div class="section">
    <h3>🧪 测试功能</h3>
    <button class="button" id="testAllFeatures">🚀 完整功能测试</button>
    <button class="button" id="generateLogs">📝 生成测试日志</button>
    <button class="button" id="testStorage">🗄️ 测试存储</button>
    <button class="button" id="testConflicts">⚠️ 测试冲突检测</button>
    <button class="button secondary" id="clearStorage">🧹 清除存储</button>
    <button class="button secondary" id="resetSettings">🔄 重置设置</button>
    
    <div class="status" id="statusMessage"></div>
  </div>
  
  <div class="section">
    <h3>🔍 存储状态</h3>
    <button class="button" id="viewStorage">📋 查看存储内容</button>
    <div class="debug-info" id="storageContent" style="display: none;"></div>
  </div>
  
  <div class="section">
    <h3>📈 实时信息</h3>
    <div class="debug-info" id="realTimeInfo"></div>
  </div>

  <script>
    // Options page script for MCP Debug Test Extension
    console.log('[Options] 🛠️ 选项页面加载');
    
    const elements = {
      extensionId: document.getElementById('extensionId'),
      extensionVersion: document.getElementById('extensionVersion'),
      manifestVersion: document.getElementById('manifestVersion'),
      enableVerboseLogging: document.getElementById('enableVerboseLogging'),
      enablePerformanceMonitoring: document.getElementById('enablePerformanceMonitoring'),
      enableConflictDetection: document.getElementById('enableConflictDetection'),
      logLevel: document.getElementById('logLevel'),
      statusMessage: document.getElementById('statusMessage'),
      storageContent: document.getElementById('storageContent'),
      realTimeInfo: document.getElementById('realTimeInfo')
    };
    
    // 显示状态消息
    function showStatus(message, type = 'success') {
      elements.statusMessage.textContent = message;
      elements.statusMessage.className = `status ${type}`;
      elements.statusMessage.style.display = 'block';
      
      setTimeout(() => {
        elements.statusMessage.style.display = 'none';
      }, 3000);
      
      console.log(`[Options] ${type.toUpperCase()}:`, message);
    }
    
    // 发送消息到background
    function sendBackgroundMessage(type, data = {}) {
      return new Promise((resolve) => {
        chrome.runtime.sendMessage({ type, ...data }, (response) => {
          resolve(response);
        });
      });
    }
    
    // 初始化扩展信息
    function initializeExtensionInfo() {
      const manifest = chrome.runtime.getManifest();
      elements.extensionId.value = chrome.runtime.id;
      elements.extensionVersion.value = manifest.version;
      elements.manifestVersion.value = manifest.manifest_version;
      
      console.log('[Options] 📋 扩展信息已初始化');
    }
    
    // 加载设置
    async function loadSettings() {
      try {
        const settings = await chrome.storage.local.get([
          'enableVerboseLogging',
          'enablePerformanceMonitoring', 
          'enableConflictDetection',
          'logLevel'
        ]);
        
        elements.enableVerboseLogging.checked = settings.enableVerboseLogging || false;
        elements.enablePerformanceMonitoring.checked = settings.enablePerformanceMonitoring || true;
        elements.enableConflictDetection.checked = settings.enableConflictDetection || true;
        elements.logLevel.value = settings.logLevel || 'info';
        
        console.log('[Options] ⚙️ 设置已加载:', settings);
      } catch (error) {
        console.error('[Options] ❌ 加载设置失败:', error);
      }
    }
    
    // 保存设置
    async function saveSettings() {
      try {
        const settings = {
          enableVerboseLogging: elements.enableVerboseLogging.checked,
          enablePerformanceMonitoring: elements.enablePerformanceMonitoring.checked,
          enableConflictDetection: elements.enableConflictDetection.checked,
          logLevel: elements.logLevel.value,
          lastModified: new Date().toISOString()
        };
        
        await chrome.storage.local.set(settings);
        showStatus('✅ 设置已保存');
        
        console.log('[Options] 💾 设置已保存:', settings);
      } catch (error) {
        console.error('[Options] ❌ 保存设置失败:', error);
        showStatus('❌ 保存设置失败', 'error');
      }
    }
    
    // 查看存储内容
    async function viewStorageContent() {
      try {
        const allData = await chrome.storage.local.get();
        elements.storageContent.textContent = JSON.stringify(allData, null, 2);
        elements.storageContent.style.display = 'block';
        
        console.log('[Options] 📋 存储内容:', allData);
      } catch (error) {
        console.error('[Options] ❌ 获取存储内容失败:', error);
      }
    }
    
    // 更新实时信息
    function updateRealTimeInfo() {
      const info = {
        timestamp: new Date().toISOString(),
        location: window.location.href,
        memory: performance.memory ? {
          used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) + 'MB',
          total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024) + 'MB'
        } : 'N/A',
        chromeAPIAvailable: {
          storage: !!chrome.storage,
          runtime: !!chrome.runtime,
          tabs: !!chrome.tabs
        }
      };
      
      elements.realTimeInfo.textContent = JSON.stringify(info, null, 2);
    }
    
    // 事件监听器
    document.getElementById('testAllFeatures').addEventListener('click', async () => {
      console.log('[Options] 🚀 开始完整功能测试');
      showStatus('🚀 开始完整功能测试...');
      
      try {
        // 测试存储
        await sendBackgroundMessage('test-storage');
        console.log('[Options] ✅ 存储测试完成');
        
        // 测试性能
        await sendBackgroundMessage('performance-test');
        console.log('[Options] ✅ 性能测试完成');
        
        // 生成日志
        console.log('[Options] 📝 测试日志');
        console.info('[Options] ℹ️ 信息测试');
        console.warn('[Options] ⚠️ 警告测试');
        
        showStatus('✅ 完整功能测试完成');
      } catch (error) {
        console.error('[Options] ❌ 功能测试失败:', error);
        showStatus('❌ 功能测试失败', 'error');
      }
    });
    
    document.getElementById('generateLogs').addEventListener('click', () => {
      console.log('[Options] 📝 用户触发日志生成');
      console.info('[Options] ℹ️ 信息级别日志测试');
      console.warn('[Options] ⚠️ 警告级别日志测试');
      console.error('[Options] ❌ 错误级别日志测试');
      console.debug('[Options] 🐛 调试级别日志测试');
      
      showStatus('📝 测试日志已生成');
    });
    
    document.getElementById('testStorage').addEventListener('click', async () => {
      await sendBackgroundMessage('test-storage');
      showStatus('🗄️ 存储测试完成');
    });
    
    document.getElementById('testConflicts').addEventListener('click', () => {
      // 创建一些潜在冲突的测试
      const testElement = document.createElement('div');
      testElement.id = 'content'; // 可能与页面冲突的ID
      testElement.style.zIndex = '999999';
      document.body.appendChild(testElement);
      
      console.log('[Options] ⚠️ 冲突测试元素已创建');
      showStatus('⚠️ 冲突测试已执行');
    });
    
    document.getElementById('clearStorage').addEventListener('click', async () => {
      try {
        await chrome.storage.local.clear();
        showStatus('🧹 存储已清除');
        console.log('[Options] 🧹 存储已清除');
      } catch (error) {
        console.error('[Options] ❌ 清除存储失败:', error);
        showStatus('❌ 清除存储失败', 'error');
      }
    });
    
    document.getElementById('resetSettings').addEventListener('click', async () => {
      elements.enableVerboseLogging.checked = false;
      elements.enablePerformanceMonitoring.checked = true;
      elements.enableConflictDetection.checked = true;
      elements.logLevel.value = 'info';
      
      await saveSettings();
      showStatus('🔄 设置已重置');
    });
    
    document.getElementById('viewStorage').addEventListener('click', viewStorageContent);
    
    // 设置变更时自动保存
    ['enableVerboseLogging', 'enablePerformanceMonitoring', 'enableConflictDetection', 'logLevel'].forEach(id => {
      document.getElementById(id).addEventListener('change', saveSettings);
    });
    
    // 初始化
    initializeExtensionInfo();
    loadSettings();
    updateRealTimeInfo();
    
    // 定期更新实时信息
    setInterval(updateRealTimeInfo, 3000);
    
    console.log('[Options] ✨ 选项页面初始化完成');
  </script>
</body>
</html>
