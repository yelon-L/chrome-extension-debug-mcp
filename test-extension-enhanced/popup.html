<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body {
      width: 350px;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin: 0;
    }
    
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .header h2 {
      margin: 0 0 5px 0;
      font-size: 18px;
    }
    
    .header p {
      margin: 0;
      font-size: 12px;
      opacity: 0.8;
    }
    
    .section {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      backdrop-filter: blur(10px);
    }
    
    .section h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #FFD700;
    }
    
    .action-btn {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border: none;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.3s ease;
    }
    
    .action-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }
    
    .status {
      font-size: 11px;
      padding: 5px;
      border-radius: 3px;
      margin: 5px 0;
      text-align: center;
    }
    
    .status.success {
      background: rgba(76, 175, 80, 0.3);
    }
    
    .status.error {
      background: rgba(244, 67, 54, 0.3);
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    
    .info-item {
      background: rgba(0, 0, 0, 0.2);
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
    }
    
    .info-label {
      font-weight: bold;
      margin-bottom: 3px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>ğŸ“¡ Enhanced MCP Test</h2>
    <p>Week 3 åŠŸèƒ½æµ‹è¯•æ§åˆ¶é¢æ¿</p>
  </div>

  <div class="section">
    <h3>ğŸš€ æ¶ˆæ¯æµ‹è¯•</h3>
    <button class="action-btn" id="sendTestMessage">å‘é€æµ‹è¯•æ¶ˆæ¯</button>
    <button class="action-btn" id="triggerAlarm">è§¦å‘é—¹é’Ÿæµ‹è¯•</button>
    <div id="messageStatus" class="status"></div>
  </div>

  <div class="section">
    <h3>ğŸ’¾ å­˜å‚¨æµ‹è¯•</h3>
    <button class="action-btn" id="testStorage">æµ‹è¯•å­˜å‚¨API</button>
    <button class="action-btn" id="clearStorage">æ¸…é™¤æµ‹è¯•æ•°æ®</button>
    <div id="storageStatus" class="status"></div>
  </div>

  <div class="section">
    <h3>ğŸ“Š æ€§èƒ½æµ‹è¯•</h3>
    <button class="action-btn" id="performanceTest">æ‰§è¡Œæ€§èƒ½æµ‹è¯•</button>
    <button class="action-btn" id="memoryCheck">å†…å­˜ä½¿ç”¨æ£€æŸ¥</button>
    <div id="performanceStatus" class="status"></div>
  </div>

  <div class="section">
    <h3>ğŸ“‹ æ‰©å±•ä¿¡æ¯</h3>
    <div class="info-grid">
      <div class="info-item">
        <div class="info-label">æ‰©å±•ID</div>
        <div id="extensionId">åŠ è½½ä¸­...</div>
      </div>
      <div class="info-item">
        <div class="info-label">ç‰ˆæœ¬</div>
        <div id="extensionVersion">åŠ è½½ä¸­...</div>
      </div>
      <div class="info-item">
        <div class="info-label">æ¶ˆæ¯è®¡æ•°</div>
        <div id="messageCount">0</div>
      </div>
      <div class="info-item">
        <div class="info-label">æ´»åŠ¨æ ‡ç­¾</div>
        <div id="activeTab">æ£€æŸ¥ä¸­...</div>
      </div>
    </div>
  </div>

  <div class="section">
    <h3>ğŸ”§ è°ƒè¯•æ§åˆ¶</h3>
    <button class="action-btn" id="startMonitoring">å¼€å§‹æ¶ˆæ¯ç›‘æ§</button>
    <button class="action-btn" id="stopMonitoring">åœæ­¢ç›‘æ§</button>
    <button class="action-btn" id="exportLogs">å¯¼å‡ºæ—¥å¿—æ•°æ®</button>
  </div>

  <script>
    // Week 3æµ‹è¯•ï¼šPopupäº¤äº’é€»è¾‘
    let messageCounter = 0;
    
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('[Enhanced Popup] ğŸš€ Popupåˆå§‹åŒ–');
      
      // åŠ è½½æ‰©å±•ä¿¡æ¯
      await loadExtensionInfo();
      
      // ç»‘å®šäº‹ä»¶å¤„ç†å™¨
      bindEventHandlers();
      
      // å¼€å§‹å®šæœŸæ›´æ–°
      startPeriodicUpdates();
    });
    
    async function loadExtensionInfo() {
      try {
        const manifest = chrome.runtime.getManifest();
        document.getElementById('extensionId').textContent = chrome.runtime.id;
        document.getElementById('extensionVersion').textContent = manifest.version;
        
        // è·å–æ´»åŠ¨æ ‡ç­¾ä¿¡æ¯
        const tabs = await chrome.tabs.query({ active: true, currentWindow: true });
        const activeTab = tabs[0];
        document.getElementById('activeTab').textContent = 
          activeTab ? `Tab ${activeTab.id}` : 'æœªæ‰¾åˆ°';
          
        console.log('[Enhanced Popup] âœ… æ‰©å±•ä¿¡æ¯åŠ è½½å®Œæˆ');
      } catch (error) {
        console.error('[Enhanced Popup] âŒ åŠ è½½æ‰©å±•ä¿¡æ¯å¤±è´¥:', error);
      }
    }
    
    function bindEventHandlers() {
      // å‘é€æµ‹è¯•æ¶ˆæ¯
      document.getElementById('sendTestMessage').addEventListener('click', async () => {
        try {
          messageCounter++;
          updateStatus('messageStatus', 'å‘é€æµ‹è¯•æ¶ˆæ¯ä¸­...', 'success');
          
          const tabs = await chrome.tabs.query({ active: true, currentWindow: true });
          const activeTab = tabs[0];
          
          if (activeTab && activeTab.id) {
            await chrome.tabs.sendMessage(activeTab.id, {
              type: 'popup_test_message',
              counter: messageCounter,
              timestamp: Date.now()
            });
            
            updateStatus('messageStatus', `æ¶ˆæ¯ #${messageCounter} å‘é€æˆåŠŸ`, 'success');
            document.getElementById('messageCount').textContent = messageCounter;
          } else {
            updateStatus('messageStatus', 'æ²¡æœ‰æ´»åŠ¨æ ‡ç­¾é¡µ', 'error');
          }
        } catch (error) {
          updateStatus('messageStatus', 'å‘é€å¤±è´¥: ' + error.message, 'error');
        }
      });
      
      // è§¦å‘é—¹é’Ÿæµ‹è¯•
      document.getElementById('triggerAlarm').addEventListener('click', () => {
        try {
          chrome.alarms.create('popup_test_alarm', { delayInMinutes: 0.05 });
          updateStatus('messageStatus', 'é—¹é’Ÿå·²è®¾ç½®', 'success');
        } catch (error) {
          updateStatus('messageStatus', 'é—¹é’Ÿè®¾ç½®å¤±è´¥: ' + error.message, 'error');
        }
      });
      
      // å­˜å‚¨æµ‹è¯•
      document.getElementById('testStorage').addEventListener('click', async () => {
        try {
          updateStatus('storageStatus', 'æ‰§è¡Œå­˜å‚¨æµ‹è¯•...', 'success');
          
          const testData = {
            popupTest: true,
            timestamp: Date.now(),
            counter: messageCounter
          };
          
          await chrome.storage.local.set({ 'popup_test': testData });
          const result = await chrome.storage.local.get(['popup_test']);
          
          updateStatus('storageStatus', 'å­˜å‚¨æµ‹è¯•æˆåŠŸ', 'success');
          console.log('[Enhanced Popup] ğŸ’¾ å­˜å‚¨æµ‹è¯•ç»“æœ:', result);
        } catch (error) {
          updateStatus('storageStatus', 'å­˜å‚¨æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
        }
      });
      
      // æ¸…é™¤å­˜å‚¨
      document.getElementById('clearStorage').addEventListener('click', async () => {
        try {
          await chrome.storage.local.clear();
          updateStatus('storageStatus', 'å­˜å‚¨å·²æ¸…é™¤', 'success');
        } catch (error) {
          updateStatus('storageStatus', 'æ¸…é™¤å¤±è´¥: ' + error.message, 'error');
        }
      });
      
      // æ€§èƒ½æµ‹è¯•
      document.getElementById('performanceTest').addEventListener('click', () => {
        try {
          const startTime = performance.now();
          
          // æ‰§è¡Œä¸€äº›è®¡ç®—å¯†é›†å‹æ“ä½œ
          let sum = 0;
          for (let i = 0; i < 100000; i++) {
            sum += Math.sqrt(i);
          }
          
          const endTime = performance.now();
          const duration = (endTime - startTime).toFixed(2);
          
          updateStatus('performanceStatus', `è®¡ç®—è€—æ—¶: ${duration}ms`, 'success');
        } catch (error) {
          updateStatus('performanceStatus', 'æ€§èƒ½æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
        }
      });
      
      // å†…å­˜æ£€æŸ¥
      document.getElementById('memoryCheck').addEventListener('click', () => {
        try {
          if (performance.memory) {
            const used = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
            const total = (performance.memory.totalJSHeapSize / 1024 / 1024).toFixed(2);
            
            updateStatus('performanceStatus', `å†…å­˜: ${used}/${total}MB`, 'success');
          } else {
            updateStatus('performanceStatus', 'å†…å­˜ä¿¡æ¯ä¸å¯ç”¨', 'error');
          }
        } catch (error) {
          updateStatus('performanceStatus', 'å†…å­˜æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
        }
      });
    }
    
    function updateStatus(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = `status ${type}`;
    }
    
    function startPeriodicUpdates() {
      setInterval(() => {
        // å®šæœŸæ›´æ–°æ¶ˆæ¯è®¡æ•°æ˜¾ç¤º
        document.getElementById('messageCount').textContent = messageCounter;
      }, 1000);
    }
  </script>
  
  <!-- Phase 2: UI Automation Test Elements -->
  <div class="test-section" style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
    <h3 style="margin: 0 0 10px 0; font-size: 14px;">ğŸ¯ Phase 2: UIæµ‹è¯•å…ƒç´ </h3>
    
    <!-- æŒ‰é’®æµ‹è¯• -->
    <div style="margin-bottom: 10px;">
      <button id="testButton1" class="btn" style="margin-right: 5px;">æµ‹è¯•æŒ‰é’®1</button>
      <button id="testButton2" class="btn" data-test="button-2">æµ‹è¯•æŒ‰é’®2</button>
      <span id="buttonStatus"></span>
    </div>
    
    <!-- è¾“å…¥æ¡†æµ‹è¯• -->
    <div style="margin-bottom: 10px;">
      <input type="text" id="testInput1" placeholder="è¾“å…¥æ¡†1" style="width: 45%; margin-right: 5px;" />
      <input type="text" id="testInput2" placeholder="è¾“å…¥æ¡†2" data-test="input-2" style="width: 45%;" />
    </div>
    
    <!-- è¡¨å•æµ‹è¯• -->
    <form id="testForm" style="margin-bottom: 10px;">
      <input type="text" name="username" placeholder="ç”¨æˆ·å" style="width: 100%; margin-bottom: 5px;" />
      <input type="email" name="email" placeholder="é‚®ç®±" style="width: 100%; margin-bottom: 5px;" />
      <select name="role" style="width: 100%; margin-bottom: 5px;">
        <option value="">é€‰æ‹©è§’è‰²</option>
        <option value="user">ç”¨æˆ·</option>
        <option value="admin">ç®¡ç†å‘˜</option>
      </select>
      <button type="submit" class="btn">æäº¤è¡¨å•</button>
    </form>
    
    <!-- å¯æ‚¬åœå…ƒç´  -->
    <div id="hoverTarget" style="padding: 10px; background: rgba(255,255,255,0.2); border-radius: 4px; margin-bottom: 10px; cursor: pointer;">
      æ‚¬åœæˆ‘æŸ¥çœ‹æ•ˆæœ
    </div>
    
    <!-- å¯æ‹–æ‹½å…ƒç´  -->
    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
      <div id="dragSource" draggable="true" style="padding: 10px; background: #4CAF50; border-radius: 4px; cursor: move;">
        æ‹–æ‹½æº
      </div>
      <div id="dropTarget" style="padding: 10px; background: rgba(255,255,255,0.2); border-radius: 4px; border: 2px dashed white;">
        æ”¾ç½®åŒº
      </div>
    </div>
    
    <!-- ARIAæ ‡ç­¾å…ƒç´  -->
    <button aria-label="å…³é—­å¯¹è¯æ¡†" id="closeButton" class="btn">âœ•</button>
    <div role="alert" id="alertBox" style="display:none; padding: 10px; background: #f44336; border-radius: 4px; margin-top: 10px;">
      è­¦å‘Šä¿¡æ¯
    </div>
    
    <!-- Phase 2.2: é«˜çº§äº¤äº’æµ‹è¯•å…ƒç´  -->
    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
      <!-- æ–‡ä»¶ä¸Šä¼  -->
      <div style="margin-bottom: 10px;">
        <label style="display: block; margin-bottom: 5px; font-size: 12px;">æ–‡ä»¶ä¸Šä¼ æµ‹è¯•:</label>
        <input type="file" id="fileInput" accept="image/*" style="width: 100%; font-size: 11px;" />
        <div id="fileStatus" style="margin-top: 5px; font-size: 11px;"></div>
      </div>
      
      <!-- å¯¹è¯æ¡†è§¦å‘ -->
      <div style="margin-bottom: 10px;">
        <button id="confirmBtn" class="btn" style="width: 100%;">è§¦å‘ç¡®è®¤å¯¹è¯æ¡†</button>
        <button id="promptBtn" class="btn" style="width: 100%; margin-top: 5px;">è§¦å‘æç¤ºå¯¹è¯æ¡†</button>
      </div>
    </div>
  </div>
  
  <script>
    // Phase 2 æµ‹è¯•å…ƒç´ äº¤äº’é€»è¾‘
    document.getElementById('testButton1').addEventListener('click', () => {
      document.getElementById('buttonStatus').textContent = 'æŒ‰é’®1å·²ç‚¹å‡» âœ“';
    });
    
    document.getElementById('testButton2').addEventListener('click', () => {
      document.getElementById('buttonStatus').textContent = 'æŒ‰é’®2å·²ç‚¹å‡» âœ“';
    });
    
    document.getElementById('testForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      console.log('[Form Submit]', Object.fromEntries(formData));
      alert('è¡¨å•å·²æäº¤: ' + JSON.stringify(Object.fromEntries(formData)));
    });
    
    document.getElementById('hoverTarget').addEventListener('mouseenter', () => {
      document.getElementById('hoverTarget').style.background = 'rgba(255,255,255,0.4)';
      document.getElementById('hoverTarget').textContent = 'å·²æ‚¬åœ! âœ“';
    });
    
    document.getElementById('hoverTarget').addEventListener('mouseleave', () => {
      document.getElementById('hoverTarget').style.background = 'rgba(255,255,255,0.2)';
      document.getElementById('hoverTarget').textContent = 'æ‚¬åœæˆ‘æŸ¥çœ‹æ•ˆæœ';
    });
    
    // æ‹–æ‹½é€»è¾‘
    document.getElementById('dragSource').addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text/plain', 'dragged');
    });
    
    document.getElementById('dropTarget').addEventListener('dragover', (e) => {
      e.preventDefault();
      e.currentTarget.style.background = 'rgba(76, 175, 80, 0.3)';
    });
    
    document.getElementById('dropTarget').addEventListener('dragleave', (e) => {
      e.currentTarget.style.background = 'rgba(255,255,255,0.2)';
    });
    
    document.getElementById('dropTarget').addEventListener('drop', (e) => {
      e.preventDefault();
      e.currentTarget.textContent = 'å·²æ”¾ç½® âœ“';
      e.currentTarget.style.background = '#4CAF50';
    });
    
    document.getElementById('closeButton').addEventListener('click', () => {
      const alertBox = document.getElementById('alertBox');
      alertBox.style.display = alertBox.style.display === 'none' ? 'block' : 'none';
    });
    
    // Phase 2.2: æ–‡ä»¶ä¸Šä¼ å¤„ç†
    document.getElementById('fileInput').addEventListener('change', (e) => {
      const files = e.target.files;
      if (files && files.length > 0) {
        const file = files[0];
        document.getElementById('fileStatus').textContent = 
          `å·²é€‰æ‹©: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
        console.log('[File Upload]', { name: file.name, size: file.size, type: file.type });
      }
    });
    
    // Phase 2.2: å¯¹è¯æ¡†å¤„ç†
    document.getElementById('confirmBtn').addEventListener('click', () => {
      const result = confirm('è¿™æ˜¯ä¸€ä¸ªç¡®è®¤å¯¹è¯æ¡†ï¼Œç‚¹å‡»ç¡®å®šæˆ–å–æ¶ˆ');
      console.log('[Confirm Dialog]', result);
    });
    
    document.getElementById('promptBtn').addEventListener('click', () => {
      const result = prompt('è¯·è¾“å…¥ä¸€äº›æ–‡æœ¬:', 'é»˜è®¤å€¼');
      console.log('[Prompt Dialog]', result);
      if (result !== null) {
        alert(`ä½ è¾“å…¥äº†: ${result}`);
      }
    });
  </script>
  
  <!-- å¼•å…¥popupè„šæœ¬ -->
  <script src="popup.js"></script>
</body>
</html>
