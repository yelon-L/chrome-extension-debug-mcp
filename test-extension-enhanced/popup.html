<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body {
      width: 350px;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin: 0;
    }
    
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .header h2 {
      margin: 0 0 5px 0;
      font-size: 18px;
    }
    
    .header p {
      margin: 0;
      font-size: 12px;
      opacity: 0.8;
    }
    
    .section {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      backdrop-filter: blur(10px);
    }
    
    .section h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #FFD700;
    }
    
    .action-btn {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border: none;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.3s ease;
    }
    
    .action-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }
    
    .status {
      font-size: 11px;
      padding: 5px;
      border-radius: 3px;
      margin: 5px 0;
      text-align: center;
    }
    
    .status.success {
      background: rgba(76, 175, 80, 0.3);
    }
    
    .status.error {
      background: rgba(244, 67, 54, 0.3);
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    
    .info-item {
      background: rgba(0, 0, 0, 0.2);
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
    }
    
    .info-label {
      font-weight: bold;
      margin-bottom: 3px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>📡 Enhanced MCP Test</h2>
    <p>Week 3 功能测试控制面板</p>
  </div>

  <div class="section">
    <h3>🚀 消息测试</h3>
    <button class="action-btn" id="sendTestMessage">发送测试消息</button>
    <button class="action-btn" id="triggerAlarm">触发闹钟测试</button>
    <div id="messageStatus" class="status"></div>
  </div>

  <div class="section">
    <h3>💾 存储测试</h3>
    <button class="action-btn" id="testStorage">测试存储API</button>
    <button class="action-btn" id="clearStorage">清除测试数据</button>
    <div id="storageStatus" class="status"></div>
  </div>

  <div class="section">
    <h3>📊 性能测试</h3>
    <button class="action-btn" id="performanceTest">执行性能测试</button>
    <button class="action-btn" id="memoryCheck">内存使用检查</button>
    <div id="performanceStatus" class="status"></div>
  </div>

  <div class="section">
    <h3>📋 扩展信息</h3>
    <div class="info-grid">
      <div class="info-item">
        <div class="info-label">扩展ID</div>
        <div id="extensionId">加载中...</div>
      </div>
      <div class="info-item">
        <div class="info-label">版本</div>
        <div id="extensionVersion">加载中...</div>
      </div>
      <div class="info-item">
        <div class="info-label">消息计数</div>
        <div id="messageCount">0</div>
      </div>
      <div class="info-item">
        <div class="info-label">活动标签</div>
        <div id="activeTab">检查中...</div>
      </div>
    </div>
  </div>

  <div class="section">
    <h3>🔧 调试控制</h3>
    <button class="action-btn" id="startMonitoring">开始消息监控</button>
    <button class="action-btn" id="stopMonitoring">停止监控</button>
    <button class="action-btn" id="exportLogs">导出日志数据</button>
  </div>

  <script>
    // Week 3测试：Popup交互逻辑
    let messageCounter = 0;
    
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('[Enhanced Popup] 🚀 Popup初始化');
      
      // 加载扩展信息
      await loadExtensionInfo();
      
      // 绑定事件处理器
      bindEventHandlers();
      
      // 开始定期更新
      startPeriodicUpdates();
    });
    
    async function loadExtensionInfo() {
      try {
        const manifest = chrome.runtime.getManifest();
        document.getElementById('extensionId').textContent = chrome.runtime.id;
        document.getElementById('extensionVersion').textContent = manifest.version;
        
        // 获取活动标签信息
        const tabs = await chrome.tabs.query({ active: true, currentWindow: true });
        const activeTab = tabs[0];
        document.getElementById('activeTab').textContent = 
          activeTab ? `Tab ${activeTab.id}` : '未找到';
          
        console.log('[Enhanced Popup] ✅ 扩展信息加载完成');
      } catch (error) {
        console.error('[Enhanced Popup] ❌ 加载扩展信息失败:', error);
      }
    }
    
    function bindEventHandlers() {
      // 发送测试消息
      document.getElementById('sendTestMessage').addEventListener('click', async () => {
        try {
          messageCounter++;
          updateStatus('messageStatus', '发送测试消息中...', 'success');
          
          const tabs = await chrome.tabs.query({ active: true, currentWindow: true });
          const activeTab = tabs[0];
          
          if (activeTab && activeTab.id) {
            await chrome.tabs.sendMessage(activeTab.id, {
              type: 'popup_test_message',
              counter: messageCounter,
              timestamp: Date.now()
            });
            
            updateStatus('messageStatus', `消息 #${messageCounter} 发送成功`, 'success');
            document.getElementById('messageCount').textContent = messageCounter;
          } else {
            updateStatus('messageStatus', '没有活动标签页', 'error');
          }
        } catch (error) {
          updateStatus('messageStatus', '发送失败: ' + error.message, 'error');
        }
      });
      
      // 触发闹钟测试
      document.getElementById('triggerAlarm').addEventListener('click', () => {
        try {
          chrome.alarms.create('popup_test_alarm', { delayInMinutes: 0.05 });
          updateStatus('messageStatus', '闹钟已设置', 'success');
        } catch (error) {
          updateStatus('messageStatus', '闹钟设置失败: ' + error.message, 'error');
        }
      });
      
      // 存储测试
      document.getElementById('testStorage').addEventListener('click', async () => {
        try {
          updateStatus('storageStatus', '执行存储测试...', 'success');
          
          const testData = {
            popupTest: true,
            timestamp: Date.now(),
            counter: messageCounter
          };
          
          await chrome.storage.local.set({ 'popup_test': testData });
          const result = await chrome.storage.local.get(['popup_test']);
          
          updateStatus('storageStatus', '存储测试成功', 'success');
          console.log('[Enhanced Popup] 💾 存储测试结果:', result);
        } catch (error) {
          updateStatus('storageStatus', '存储测试失败: ' + error.message, 'error');
        }
      });
      
      // 清除存储
      document.getElementById('clearStorage').addEventListener('click', async () => {
        try {
          await chrome.storage.local.clear();
          updateStatus('storageStatus', '存储已清除', 'success');
        } catch (error) {
          updateStatus('storageStatus', '清除失败: ' + error.message, 'error');
        }
      });
      
      // 性能测试
      document.getElementById('performanceTest').addEventListener('click', () => {
        try {
          const startTime = performance.now();
          
          // 执行一些计算密集型操作
          let sum = 0;
          for (let i = 0; i < 100000; i++) {
            sum += Math.sqrt(i);
          }
          
          const endTime = performance.now();
          const duration = (endTime - startTime).toFixed(2);
          
          updateStatus('performanceStatus', `计算耗时: ${duration}ms`, 'success');
        } catch (error) {
          updateStatus('performanceStatus', '性能测试失败: ' + error.message, 'error');
        }
      });
      
      // 内存检查
      document.getElementById('memoryCheck').addEventListener('click', () => {
        try {
          if (performance.memory) {
            const used = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
            const total = (performance.memory.totalJSHeapSize / 1024 / 1024).toFixed(2);
            
            updateStatus('performanceStatus', `内存: ${used}/${total}MB`, 'success');
          } else {
            updateStatus('performanceStatus', '内存信息不可用', 'error');
          }
        } catch (error) {
          updateStatus('performanceStatus', '内存检查失败: ' + error.message, 'error');
        }
      });
    }
    
    function updateStatus(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = `status ${type}`;
    }
    
    function startPeriodicUpdates() {
      setInterval(() => {
        // 定期更新消息计数显示
        document.getElementById('messageCount').textContent = messageCounter;
      }, 1000);
    }
  </script>
  
  <!-- Phase 2: UI Automation Test Elements -->
  <div class="test-section" style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
    <h3 style="margin: 0 0 10px 0; font-size: 14px;">🎯 Phase 2: UI测试元素</h3>
    
    <!-- 按钮测试 -->
    <div style="margin-bottom: 10px;">
      <button id="testButton1" class="btn" style="margin-right: 5px;">测试按钮1</button>
      <button id="testButton2" class="btn" data-test="button-2">测试按钮2</button>
      <span id="buttonStatus"></span>
    </div>
    
    <!-- 输入框测试 -->
    <div style="margin-bottom: 10px;">
      <input type="text" id="testInput1" placeholder="输入框1" style="width: 45%; margin-right: 5px;" />
      <input type="text" id="testInput2" placeholder="输入框2" data-test="input-2" style="width: 45%;" />
    </div>
    
    <!-- 表单测试 -->
    <form id="testForm" style="margin-bottom: 10px;">
      <input type="text" name="username" placeholder="用户名" style="width: 100%; margin-bottom: 5px;" />
      <input type="email" name="email" placeholder="邮箱" style="width: 100%; margin-bottom: 5px;" />
      <select name="role" style="width: 100%; margin-bottom: 5px;">
        <option value="">选择角色</option>
        <option value="user">用户</option>
        <option value="admin">管理员</option>
      </select>
      <button type="submit" class="btn">提交表单</button>
    </form>
    
    <!-- 可悬停元素 -->
    <div id="hoverTarget" style="padding: 10px; background: rgba(255,255,255,0.2); border-radius: 4px; margin-bottom: 10px; cursor: pointer;">
      悬停我查看效果
    </div>
    
    <!-- 可拖拽元素 -->
    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
      <div id="dragSource" draggable="true" style="padding: 10px; background: #4CAF50; border-radius: 4px; cursor: move;">
        拖拽源
      </div>
      <div id="dropTarget" style="padding: 10px; background: rgba(255,255,255,0.2); border-radius: 4px; border: 2px dashed white;">
        放置区
      </div>
    </div>
    
    <!-- ARIA标签元素 -->
    <button aria-label="关闭对话框" id="closeButton" class="btn">✕</button>
    <div role="alert" id="alertBox" style="display:none; padding: 10px; background: #f44336; border-radius: 4px; margin-top: 10px;">
      警告信息
    </div>
    
    <!-- Phase 2.2: 高级交互测试元素 -->
    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
      <!-- 文件上传 -->
      <div style="margin-bottom: 10px;">
        <label style="display: block; margin-bottom: 5px; font-size: 12px;">文件上传测试:</label>
        <input type="file" id="fileInput" accept="image/*" style="width: 100%; font-size: 11px;" />
        <div id="fileStatus" style="margin-top: 5px; font-size: 11px;"></div>
      </div>
      
      <!-- 对话框触发 -->
      <div style="margin-bottom: 10px;">
        <button id="confirmBtn" class="btn" style="width: 100%;">触发确认对话框</button>
        <button id="promptBtn" class="btn" style="width: 100%; margin-top: 5px;">触发提示对话框</button>
      </div>
    </div>
  </div>
  
  <script>
    // Phase 2 测试元素交互逻辑
    document.getElementById('testButton1').addEventListener('click', () => {
      document.getElementById('buttonStatus').textContent = '按钮1已点击 ✓';
    });
    
    document.getElementById('testButton2').addEventListener('click', () => {
      document.getElementById('buttonStatus').textContent = '按钮2已点击 ✓';
    });
    
    document.getElementById('testForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      console.log('[Form Submit]', Object.fromEntries(formData));
      alert('表单已提交: ' + JSON.stringify(Object.fromEntries(formData)));
    });
    
    document.getElementById('hoverTarget').addEventListener('mouseenter', () => {
      document.getElementById('hoverTarget').style.background = 'rgba(255,255,255,0.4)';
      document.getElementById('hoverTarget').textContent = '已悬停! ✓';
    });
    
    document.getElementById('hoverTarget').addEventListener('mouseleave', () => {
      document.getElementById('hoverTarget').style.background = 'rgba(255,255,255,0.2)';
      document.getElementById('hoverTarget').textContent = '悬停我查看效果';
    });
    
    // 拖拽逻辑
    document.getElementById('dragSource').addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text/plain', 'dragged');
    });
    
    document.getElementById('dropTarget').addEventListener('dragover', (e) => {
      e.preventDefault();
      e.currentTarget.style.background = 'rgba(76, 175, 80, 0.3)';
    });
    
    document.getElementById('dropTarget').addEventListener('dragleave', (e) => {
      e.currentTarget.style.background = 'rgba(255,255,255,0.2)';
    });
    
    document.getElementById('dropTarget').addEventListener('drop', (e) => {
      e.preventDefault();
      e.currentTarget.textContent = '已放置 ✓';
      e.currentTarget.style.background = '#4CAF50';
    });
    
    document.getElementById('closeButton').addEventListener('click', () => {
      const alertBox = document.getElementById('alertBox');
      alertBox.style.display = alertBox.style.display === 'none' ? 'block' : 'none';
    });
    
    // Phase 2.2: 文件上传处理
    document.getElementById('fileInput').addEventListener('change', (e) => {
      const files = e.target.files;
      if (files && files.length > 0) {
        const file = files[0];
        document.getElementById('fileStatus').textContent = 
          `已选择: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
        console.log('[File Upload]', { name: file.name, size: file.size, type: file.type });
      }
    });
    
    // Phase 2.2: 对话框处理
    document.getElementById('confirmBtn').addEventListener('click', () => {
      const result = confirm('这是一个确认对话框，点击确定或取消');
      console.log('[Confirm Dialog]', result);
    });
    
    document.getElementById('promptBtn').addEventListener('click', () => {
      const result = prompt('请输入一些文本:', '默认值');
      console.log('[Prompt Dialog]', result);
      if (result !== null) {
        alert(`你输入了: ${result}`);
      }
    });
  </script>
  
  <!-- 引入popup脚本 -->
  <script src="popup.js"></script>
</body>
</html>
