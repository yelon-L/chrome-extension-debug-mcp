# Chrome Extension Debug MCP - 快捷工具使用指南

## 概述

快捷组合工具通过一次调用自动执行多个诊断步骤，大幅提升开发效率。本指南介绍三个快捷工具的使用方法和最佳实践。

---

## 🚀 工具列表

| 工具名称 | 功能 | 执行步骤 | 时间 | 适用场景 |
|---------|------|---------|------|---------|
| `quick_extension_debug` | 全面诊断扩展状态 | 4步 | 20-30秒 | 快速排查扩展问题 |
| `quick_performance_check` | 性能影响评估 | 2步 | 12-18秒 | 评估扩展性能开销 |
| `export_extension_network_har` | 导出网络数据 | 1步 | 10-30秒 | 深度网络分析 |

---

## 1. quick_extension_debug - 快速扩展诊断

### 功能说明

**一键完成4项检查**：
1. ✅ 扩展基本信息（ID、版本、状态）
2. ✅ 日志分析（最近50条，错误统计）
3. ✅ 内容脚本状态（注入情况）
4. ✅ 存储检查（local、sync、session配额）
5. ✅ 生成人类可读摘要

### 参数说明

```typescript
{
  extensionId: string;           // 必需：扩展ID
  includeLogs?: boolean;         // 可选：是否包含日志（默认true）
  includeContentScript?: boolean; // 可选：是否检查内容脚本（默认true）
  includeStorage?: boolean;      // 可选：是否检查存储（默认true）
  tabId?: string;                // 可选：指定标签页检查内容脚本
}
```

### 使用示例

#### 基础用法
```javascript
const result = await callTool('quick_extension_debug', {
  extensionId: 'abc123...'
});
```

#### 完整用法
```javascript
const result = await callTool('quick_extension_debug', {
  extensionId: 'abc123...',
  includeLogs: true,
  includeContentScript: true,
  includeStorage: true,
  tabId: '456'  // 可选：检查特定标签页
});
```

### 返回数据结构

```json
{
  "extensionId": "abc123...",
  "timestamp": 1704917876000,
  
  "extension": {
    "id": "abc123...",
    "name": "My Extension",
    "version": "1.0.0",
    "enabled": true,
    "offlineEnabled": false
  },
  
  "logs": {
    "total": 150,
    "recent": [
      {
        "level": "error",
        "message": "Failed to fetch data",
        "timestamp": 1704917800000
      }
    ],
    "errorCount": 5,
    "warnCount": 12
  },
  
  "contentScript": {
    "injected": true,
    "status": "active",
    "tabsAnalyzed": 3
  },
  
  "storage": {
    "local": 10,    // 10个键
    "sync": 5,      // 5个键
    "session": 2,   // 2个键
    "quota": {
      "used": 1024,
      "total": 10485760
    }
  },
  
  "summary": "快速诊断报告 for abc123...\n  - 扩展名称: My Extension\n  - 版本: 1.0.0\n  - 状态: 启用\n  - 日志: 总计 150 条, 错误 5 条, 警告 12 条\n  - 内容脚本: 已注入 (active)\n  - 存储: Local 10 项, Sync 5 项, Session 2 项\n    配额使用: 1024 / 10485760 bytes"
}
```

### 实际应用场景

#### 场景1: 用户反馈扩展不工作
```
用户: "我的扩展突然不工作了"

AI助手:
1. 调用 quick_extension_debug
2. 发现 extension.enabled = false
3. 回复: "扩展当前已禁用，请在浏览器扩展管理页面启用它"

时间: 20秒
```

#### 场景2: 排查扩展错误
```
用户: "扩展报错了"

AI助手:
1. 调用 quick_extension_debug
2. 查看 logs.recent 发现错误: "Failed to fetch data"
3. 查看 logs.errorCount = 15 (错误频繁)
4. 回复: "扩展出现15次网络请求错误，请检查API端点和网络连接"

时间: 25秒
```

#### 场景3: 内容脚本未注入
```
用户: "页面上的按钮没有反应"

AI助手:
1. 调用 quick_extension_debug (带tabId)
2. 发现 contentScript.injected = false
3. 回复: "内容脚本未注入到该页面，请检查manifest.json中的content_scripts配置"

时间: 22秒
```

### 优势对比

**传统方式**:
```javascript
// 需要手动调用4个工具
const ext = await callTool('list_extensions', {});
const logs = await callTool('get_extension_logs', { extensionId });
const cs = await callTool('content_script_status', { extensionId });
const storage = await callTool('inspect_extension_storage', { extensionId });

// 手动整合分析结果...
```
**耗时**: 4-6分钟（手动操作 + 分析）

**快捷方式**:
```javascript
// 一次调用，自动整合
const result = await callTool('quick_extension_debug', { extensionId });
// 直接使用 result.summary
```
**耗时**: 20-30秒（自动化）

**效率提升**: 12-18倍！ 🚀

---

## 2. quick_performance_check - 快速性能检测

### 功能说明

**一键完成性能+网络分析**：
1. ✅ 扩展性能影响分析（CPU、内存）
2. ✅ Core Web Vitals测量（LCP、FID、CLS）
3. ✅ 网络活动监控（2秒快速监控）
4. ✅ 综合影响评分（0-100分）
5. ✅ 生成性能摘要报告

### 参数说明

```typescript
{
  extensionId: string;    // 必需：扩展ID
  testUrl?: string;       // 可选：测试URL（默认https://example.com）
}
```

### 使用示例

#### 基础用法
```javascript
const result = await callTool('quick_performance_check', {
  extensionId: 'abc123...'
});
```

#### 指定测试URL
```javascript
const result = await callTool('quick_performance_check', {
  extensionId: 'abc123...',
  testUrl: 'https://www.google.com'
});
```

### 返回数据结构

```json
{
  "extensionId": "abc123...",
  "testUrl": "https://example.com",
  "timestamp": 1704917876000,
  
  "performance": {
    "cpuUsage": 1.4,        // CPU影响 (%)
    "memoryUsage": 0.4,     // 内存影响 (MB)
    "executionTime": 50,    // 执行时间 (ms)
    "impactScore": 97,      // 影响评分 (0-100)
    "cwv": {
      "lcp": 78.02,         // Largest Contentful Paint (ms)
      "fid": 0,             // First Input Delay (ms)
      "cls": 0.000,         // Cumulative Layout Shift
      "rating": {
        "lcp": "good",
        "fid": "good",
        "cls": "good"
      },
      "score": 100
    },
    "recommendations": [
      "扩展性能影响极小，无需优化"
    ]
  },
  
  "network": {
    "totalRequests": 5,
    "totalDataTransferred": 2048,  // bytes
    "failedRequests": 0,
    "slowestRequests": [
      {
        "url": "https://api.example.com/data",
        "duration": 120
      }
    ],
    "summary": {
      "averageResponseTime": "85ms",
      "resourceTypes": { "xhr": 3, "fetch": 2 }
    }
  },
  
  "summary": "快速性能检测报告 for abc123... (URL: https://example.com):\n  - CPU影响: 1.4% ↑\n  - 内存影响: 0.4MB ↑\n  - 综合影响评分: 97/100\n  - Core Web Vitals: LCP 78ms, FID 0ms, CLS 0.000\n  - 网络请求: 总计 5 个, 失败 0 个\n  - 总传输数据: 2.0 KB\n  - 最慢请求: https://api.example.com/data (120ms)"
}
```

### 实际应用场景

#### 场景1: 评估扩展性能影响
```
用户: "这个扩展会拖慢浏览器吗？"

AI助手:
1. 调用 quick_performance_check
2. 分析结果: impactScore = 97/100
3. 回复: "扩展性能影响极小（评分97/100）：
   - CPU增加1.4%
   - 内存增加0.4MB
   - 所有Core Web Vitals指标为'good'级别
   完全不会影响浏览体验！"

时间: 16秒
```

#### 场景2: 性能优化建议
```
用户: "扩展加载页面很慢"

AI助手:
1. 调用 quick_performance_check
2. 发现: cpuUsage = 25%, impactScore = 40/100
3. 查看 cwv.lcp = 5500ms (poor)
4. 回复: "扩展性能问题严重（评分40/100）：
   - CPU占用25%过高
   - LCP指标5.5秒（poor级别）
   建议: 
   1. 优化资源加载逻辑
   2. 减少DOM操作
   3. 使用Web Workers处理密集计算"

时间: 18秒
```

#### 场景3: 网络请求分析
```
用户: "扩展网络请求频繁"

AI助手:
1. 调用 quick_performance_check
2. 发现: totalRequests = 150 (2秒内)
3. 查看 failedRequests = 20
4. 回复: "网络活动异常：
   - 2秒内发起150个请求
   - 20个请求失败
   - 总数据传输: 500KB
   建议: 
   1. 实现请求去抖/节流
   2. 批量处理API调用
   3. 添加请求缓存"

时间: 14秒
```

### 性能评分标准

| 评分 | 等级 | 说明 | 建议 |
|------|------|------|------|
| 90-100 | 优秀 ⭐⭐⭐⭐⭐ | 性能影响极小 | 无需优化 |
| 75-89 | 良好 ⭐⭐⭐⭐☆ | 轻微影响 | 可以优化 |
| 60-74 | 一般 ⭐⭐⭐☆☆ | 中等影响 | 建议优化 |
| 40-59 | 较差 ⭐⭐☆☆☆ | 明显影响 | 必须优化 |
| 0-39 | 很差 ⭐☆☆☆☆ | 严重影响 | 紧急优化 |

### 优势对比

**传统方式**:
```javascript
const perf = await callTool('analyze_extension_performance', { 
  extensionId,
  duration: 3000 
});
const network = await callTool('track_extension_network', { 
  extensionId,
  duration: 30000 
});
// 手动分析和计算评分...
```
**耗时**: 35秒+ 手动分析时间

**快捷方式**:
```javascript
const result = await callTool('quick_performance_check', { 
  extensionId 
});
// 自动分析，16秒完成
```
**效率提升**: 2倍+ 🚀

---

## 3. export_extension_network_har - HAR格式导出

### 功能说明

**导出标准HAR 1.2格式网络数据**：
1. ✅ 收集扩展网络活动（可自定义时长）
2. ✅ 转换为HAR 1.2标准格式
3. ✅ 生成详细摘要信息
4. ✅ 支持保存文件或返回数据
5. ✅ 兼容Chrome DevTools、WebPageTest

### 参数说明

```typescript
{
  extensionId: string;      // 必需：扩展ID
  duration?: number;        // 可选：监控时长（毫秒，默认30000）
  outputPath?: string;      // 可选：保存路径
  testUrl?: string;         // 可选：测试URL
}
```

### 使用示例

#### 仅返回数据
```javascript
const result = await callTool('export_extension_network_har', {
  extensionId: 'abc123...',
  duration: 10000  // 监控10秒
});
```

#### 保存到文件
```javascript
const result = await callTool('export_extension_network_har', {
  extensionId: 'abc123...',
  duration: 30000,
  outputPath: './network-activity.har'
});
```

#### 指定测试URL
```javascript
const result = await callTool('export_extension_network_har', {
  extensionId: 'abc123...',
  testUrl: 'https://www.bing.com',
  duration: 20000
});
```

### 返回数据结构

```json
{
  "harData": {
    "log": {
      "version": "1.2",
      "creator": {
        "name": "Chrome Extension Debug MCP",
        "version": "4.0.0"
      },
      "pages": [
        {
          "startedDateTime": "2024-01-10T12:00:00.000Z",
          "id": "page_1",
          "title": "Extension Network Activity - https://example.com",
          "pageTimings": {
            "onContentLoad": -1,
            "onLoad": -1
          }
        }
      ],
      "entries": [
        {
          "startedDateTime": "2024-01-10T12:00:01.000Z",
          "time": 120,
          "request": {
            "method": "GET",
            "url": "https://api.example.com/data",
            "httpVersion": "HTTP/1.1",
            "headers": [...],
            "queryString": [...],
            "headersSize": 256,
            "bodySize": 0
          },
          "response": {
            "status": 200,
            "statusText": "OK",
            "httpVersion": "HTTP/1.1",
            "headers": [...],
            "content": {
              "size": 1024,
              "mimeType": "application/json"
            },
            "headersSize": 180,
            "bodySize": 1024
          },
          "cache": {},
          "timings": {
            "dns": 5,
            "connect": 10,
            "ssl": 15,
            "send": 1,
            "wait": 80,
            "receive": 9
          },
          "_resourceType": "xhr"
        }
      ]
    }
  },
  "savedPath": "./network-activity.har",  // 如果指定了outputPath
  "summary": {
    "totalRequests": 25,
    "totalSize": "45.6 KB",
    "averageResponseTime": "125 ms",
    "resourceTypes": {
      "xhr": 10,
      "fetch": 8,
      "script": 5,
      "image": 2
    },
    "statusCodes": {
      "200": 23,
      "404": 2
    }
  }
}
```

### 实际应用场景

#### 场景1: 深度网络分析
```
用户: "分析扩展的所有网络请求"

AI助手:
1. 调用 export_extension_network_har (30秒监控)
2. 导出HAR文件
3. 回复: "HAR文件已生成，共捕获25个请求：
   - 总数据传输: 45.6KB
   - 平均响应时间: 125ms
   - XHR请求: 10个
   - Fetch请求: 8个
   
   可在Chrome DevTools中打开该文件查看详细瀑布图"

时间: 30秒
```

#### 场景2: 性能优化分析
```
用户: "哪些请求最慢？"

AI助手:
1. 调用 export_extension_network_har
2. 分析 harData.log.entries 按 time 排序
3. 回复: "最慢的3个请求：
   1. https://api.slow.com/data - 2500ms
   2. https://cdn.example.com/large.js - 1800ms
   3. https://analytics.com/track - 950ms
   
   建议优化这些慢请求或实现异步加载"

时间: 25秒
```

#### 场景3: 错误请求排查
```
用户: "为什么有些请求失败？"

AI助手:
1. 调用 export_extension_network_har
2. 查找 status != 200 的请求
3. 回复: "发现5个失败请求：
   - https://api.example.com/old-endpoint (404)
   - https://cdn.broken.com/script.js (404)
   - https://api.timeout.com/slow (504)
   
   建议: 
   1. 更新API端点URL
   2. 检查CDN资源可用性
   3. 增加请求超时处理"

时间: 20秒
```

### HAR文件使用方法

#### 在Chrome DevTools中导入
1. 打开Chrome DevTools (F12)
2. 切换到 **Network** 面板
3. 右键点击请求列表 → **Import HAR file...**
4. 选择导出的 `.har` 文件
5. 查看瀑布图和详细信息

#### 在WebPageTest中分析
1. 访问 https://www.webpagetest.org/
2. 点击 **Upload HAR**
3. 上传 `.har` 文件
4. 查看详细性能报告

#### 使用第三方工具
- **HAR Viewer**: http://www.softwareishard.com/har/viewer/
- **Google HAR Analyzer**: Chrome扩展
- **Charles Proxy**: 导入HAR查看请求

### HAR格式优势

| 特性 | 说明 | 价值 |
|------|------|------|
| **标准化** | HTTP Archive 1.2国际标准 | 跨工具兼容 |
| **详细** | 包含完整request/response/timing | 深度分析 |
| **可视化** | DevTools瀑布图展示 | 直观易懂 |
| **分享** | JSON格式易于分享 | 团队协作 |
| **历史记录** | 保存快照对比 | 性能追踪 |

---

## 最佳实践

### 1. 选择合适的工具

| 需求 | 推荐工具 | 原因 |
|------|---------|------|
| **快速排查问题** | `quick_extension_debug` | 全面诊断，20秒完成 |
| **评估性能影响** | `quick_performance_check` | 自动计算评分，16秒完成 |
| **深度网络分析** | `export_extension_network_har` | 标准格式，工具兼容 |
| **对比性能** | 多次调用`quick_performance_check` | 相同URL测试对比 |

### 2. 组合使用

#### 完整诊断流程
```javascript
// 步骤1: 快速诊断（20秒）
const debug = await callTool('quick_extension_debug', { extensionId });
if (debug.extension.enabled && debug.logs.errorCount > 0) {
  // 发现错误，进一步分析
  
  // 步骤2: 性能检测（16秒）
  const perf = await callTool('quick_performance_check', { extensionId });
  if (perf.performance.impactScore < 70) {
    // 性能有问题，导出详细数据
    
    // 步骤3: HAR导出（30秒）
    const har = await callTool('export_extension_network_har', { 
      extensionId,
      duration: 30000
    });
  }
}

// 总耗时: 最多66秒，分阶段执行
```

### 3. 参数优化建议

#### duration (监控时长)
- **快速检测**: 2000-5000ms（足够捕获初始请求）
- **常规监控**: 10000-30000ms（平衡速度和覆盖）
- **深度分析**: 60000ms+（捕获周期性任务）

#### testUrl (测试URL)
- **简单页面**: `https://example.com`（加载快）
- **实际场景**: 目标应用URL（真实测试）
- **重量级页面**: `https://www.cnn.com`（压力测试）

### 4. 错误处理

```javascript
try {
  const result = await callTool('quick_extension_debug', { extensionId });
  
  // 检查关键字段
  if (!result.extension) {
    console.error('扩展未找到');
    return;
  }
  
  if (!result.summary) {
    console.warn('摘要生成失败，但数据可用');
  }
  
  // 处理存储超时（优雅降级）
  if (result.storage.local === 0 && result.storage.sync === 0) {
    console.info('存储读取可能超时，显示为0项');
  }
  
} catch (error) {
  console.error('工具调用失败:', error.message);
  // 回退到单独工具调用
}
```

### 5. 性能优化

#### 避免频繁调用
```javascript
// ❌ 不推荐: 频繁调用影响性能
setInterval(() => {
  callTool('quick_performance_check', { extensionId });
}, 5000);

// ✅ 推荐: 按需调用
// 仅在用户请求或发现问题时调用
```

#### 使用缓存
```javascript
const cache = new Map();
const CACHE_TTL = 60000; // 1分钟

async function cachedQuickDebug(extensionId) {
  const cacheKey = `debug_${extensionId}`;
  const cached = cache.get(cacheKey);
  
  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
    return cached.data;
  }
  
  const result = await callTool('quick_extension_debug', { extensionId });
  cache.set(cacheKey, { data: result, timestamp: Date.now() });
  return result;
}
```

---

## 常见问题

### Q1: 存储读取显示0项，但实际有数据？
**A**: 这是Service Worker休眠导致的超时。修复已实现（增加超时到10秒、自动重试2次、Service Worker唤醒）。如果仍超时，会优雅降级显示0项。

### Q2: network.totalRequests为0，但扩展有网络活动？
**A**: 可能原因：
1. 监控时长太短（增加`duration`）
2. 网络请求在监控窗口外（增加等待时间）
3. 扩展使用background发起请求（确认扩展架构）

### Q3: HAR文件很大怎么办？
**A**: 
1. 减少监控时长
2. HAR文件可用gzip压缩（压缩率通常80%+）
3. 只保留关键entries（手动编辑JSON）

### Q4: quick_performance_check结果不稳定？
**A**: 性能测量受多种因素影响：
1. 系统负载
2. 网络状况
3. 缓存状态

建议：
- 多次测试取平均值
- 使用相同testUrl对比
- 关闭其他扩展

### Q5: 工具执行很慢怎么办？
**A**: 
1. `quick_extension_debug`: 存储检查最慢，可设置`includeStorage: false`
2. `quick_performance_check`: 已使用2秒快速模式
3. `export_extension_network_har`: 减少`duration`

---

## 效率对比总结

| 任务 | 传统方式 | 快捷工具 | 提升 |
|------|---------|---------|------|
| **扩展诊断** | 4-6分钟（4个工具+手动分析） | 20秒（自动化） | **12-18倍** 🚀 |
| **性能评估** | 35秒+手动分析 | 16秒（自动化） | **2倍+** 🚀 |
| **网络分析** | 30秒+手动导出 | 10-30秒（一键完成） | **1.5倍** 🚀 |

---

## 相关文档

- [Core Web Vitals解读](./Core-Web-Vitals解读.md) - 深入理解LCP、FID、CLS指标
- [HAR分析教程](./HAR分析教程.md) - 详细HAR文件分析方法
- [README.md](../README.md) - 完整工具列表和安装指南

---

**版本**: 1.0  
**最后更新**: 2025-01-10  
**适用版本**: Chrome Extension Debug MCP 4.0.0+


